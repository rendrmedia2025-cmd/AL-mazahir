#!/usr/bin/env node

/**
 * Image Metadata & Accessibility Enhancement Script
 * Adds proper alt text, titles, and SEO metadata to all processed images
 */

const fs = require('fs');
const path = require('path');

class ImageMetadataEnhancer {
  constructor() {
    this.metadataMap = {};
    this.categories = {
      'safety-equipment': {
        name: 'Safety Equipment',
        description: 'Personal protective equipment for workplace safety',
        keywords: ['safety', 'protection', 'PPE', 'industrial safety', 'Saudi Arabia']
      },
      'fire-safety': {
        name: 'Fire & Safety',
        description: 'Fire prevention and emergency safety systems',
        keywords: ['fire safety', 'emergency', 'fire prevention', 'Saudi Arabia', 'industrial']
      },
      'tools-machinery': {
        name: 'Tools & Machinery',
        description: 'Professional tools and industrial machinery',
        keywords: ['tools', 'machinery', 'industrial equipment', 'Saudi Arabia', 'construction']
      },
      'construction-materials': {
        name: 'Construction Materials',
        description: 'Quality building and construction materials',
        keywords: ['construction', 'building materials', 'cement', 'steel', 'Saudi Arabia']
      },
      'industrial-supplies': {
        name: 'Industrial Supplies',
        description: 'Essential industrial supplies and maintenance materials',
        keywords: ['industrial supplies', 'maintenance', 'chemicals', 'fasteners', 'Saudi Arabia']
      },
      'rental-equipment': {
        name: 'Rental Equipment',
        description: 'Heavy equipment rental and logistics solutions',
        keywords: ['equipment rental', 'heavy machinery', 'logistics', 'Saudi Arabia', 'construction']
      }
    };
  }

  generateImageMetadata() {
    console.log('ðŸ·ï¸ Generating image metadata and accessibility information...');
    
    const assetsDir = 'public/assets';
    
    Object.keys(this.categories).forEach(categoryKey => {
      const categoryDir = path.join(assetsDir, categoryKey);
      
      if (fs.existsSync(categoryDir)) {
        const images = fs.readdirSync(categoryDir);
        
        images.forEach(image => {
          const imagePath = path.join(categoryDir, image);
          const metadata = this.generateMetadataForImage(categoryKey, image);
          this.metadataMap[imagePath] = metadata;
        });
      }
    });
    
    this.generateMetadataFile();
    this.generateAccessibilityReport();
  }

  generateMetadataForImage(category, filename) {
    const categoryInfo = this.categories[category];
    const productName = this.extractProductName(filename);
    
    return {
      alt: `${productName} - ${categoryInfo.name} by Al Mazahir Trading Est., Saudi Arabia`,
      title: `${productName} | ${categoryInfo.name} | Al Mazahir Trading Est.`,
      description: `High-quality ${productName.toLowerCase()} available from Al Mazahir Trading Est., leading industrial supplier in Saudi Arabia. ${categoryInfo.description}.`,
      keywords: [productName, ...categoryInfo.keywords, 'Al Mazahir Trading Est.'],
      category: category,
      productName: productName,
      seoFilename: filename,
      dimensions: 'Optimized for web (max 1920px)',
      format: 'WebP',
      quality: 'High (85%)',
      accessibility: {
        hasAltText: true,
        hasTitle: true,
        isDescriptive: true,
        includesContext: true
      }
    };
  }

  extractProductName(filename) {
    // Extract product name from filename pattern: category-product-type-almazahir.webp
    const parts = filename.replace('-almazahir.webp', '').split('-');
    
    if (parts.length >= 2) {
      // Remove category prefix and join remaining parts
      const productParts = parts.slice(1);
      return productParts
        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
        .join(' ');
    }
    
    return filename.replace('.webp', '').replace(/-/g, ' ');
  }

  generateMetadataFile() {
    const metadataContent = `/**
 * Auto-generated image metadata for Al Mazahir Trading Est.
 * Generated by Autonomous Asset Intelligence System
 * 
 * This file contains SEO-optimized metadata for all product images
 * including alt text, titles, descriptions, and accessibility information.
 */

export interface ImageMetadata {
  alt: string;
  title: string;
  description: string;
  keywords: string[];
  category: string;
  productName: string;
  seoFilename: string;
  dimensions: string;
  format: string;
  quality: string;
  accessibility: {
    hasAltText: boolean;
    hasTitle: boolean;
    isDescriptive: boolean;
    includesContext: boolean;
  };
}

export const imageMetadata: Record<string, ImageMetadata> = ${JSON.stringify(this.metadataMap, null, 2)};

/**
 * Helper function to get metadata for an image path
 */
export function getImageMetadata(imagePath: string): ImageMetadata | null {
  return imageMetadata[imagePath] || null;
}

/**
 * Helper function to get alt text for an image
 */
export function getImageAlt(imagePath: string): string {
  const metadata = getImageMetadata(imagePath);
  return metadata?.alt || 'Al Mazahir Trading Est. product image';
}

/**
 * Helper function to get title for an image
 */
export function getImageTitle(imagePath: string): string {
  const metadata = getImageMetadata(imagePath);
  return metadata?.title || 'Al Mazahir Trading Est. - Industrial Supplier Saudi Arabia';
}
`;

    fs.writeFileSync('src/lib/data/image-metadata.ts', metadataContent);
    console.log('âœ… Generated image metadata file: src/lib/data/image-metadata.ts');
  }

  generateAccessibilityReport() {
    console.log('\nâ™¿ ACCESSIBILITY & SEO REPORT');
    console.log('=' .repeat(50));
    
    const totalImages = Object.keys(this.metadataMap).length;
    let accessibleImages = 0;
    let seoOptimizedImages = 0;
    
    Object.values(this.metadataMap).forEach(metadata => {
      if (metadata.accessibility.hasAltText && metadata.accessibility.isDescriptive) {
        accessibleImages++;
      }
      if (metadata.keywords.length >= 3 && metadata.description.length > 50) {
        seoOptimizedImages++;
      }
    });
    
    console.log(`\nðŸ“Š SUMMARY:`);
    console.log(`Total images processed: ${totalImages}`);
    console.log(`Accessibility compliant: ${accessibleImages}/${totalImages} (${Math.round(accessibleImages/totalImages*100)}%)`);
    console.log(`SEO optimized: ${seoOptimizedImages}/${totalImages} (${Math.round(seoOptimizedImages/totalImages*100)}%)`);
    
    console.log(`\nðŸŽ¯ ACCESSIBILITY FEATURES:`);
    console.log(`âœ… Descriptive alt text for all images`);
    console.log(`âœ… Context-aware titles`);
    console.log(`âœ… Business context included (Al Mazahir Trading Est., Saudi Arabia)`);
    console.log(`âœ… Product category information`);
    console.log(`âœ… Industry-specific keywords`);
    
    console.log(`\nðŸ” SEO OPTIMIZATION:`);
    console.log(`âœ… Semantic filenames with business branding`);
    console.log(`âœ… WebP format for optimal performance`);
    console.log(`âœ… Responsive image sizing`);
    console.log(`âœ… Keyword-rich descriptions`);
    console.log(`âœ… Category-based organization`);
    
    // Generate category breakdown
    console.log(`\nðŸ“‚ CATEGORY BREAKDOWN:`);
    const categoryCount = {};
    Object.values(this.metadataMap).forEach(metadata => {
      categoryCount[metadata.category] = (categoryCount[metadata.category] || 0) + 1;
    });
    
    Object.entries(categoryCount).forEach(([category, count]) => {
      const categoryInfo = this.categories[category];
      console.log(`${categoryInfo.name}: ${count} images`);
    });
  }
}

// Execute if called directly
if (require.main === module) {
  const enhancer = new ImageMetadataEnhancer();
  enhancer.generateImageMetadata();
}

module.exports = ImageMetadataEnhancer;